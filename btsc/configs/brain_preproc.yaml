# Brain Preprocessing Configuration
# Controls preprocessing pipeline for brain segmentation to harmonize external data with NFBS characteristics

# Enable/disable the entire preprocessing pipeline
enable: true

# Preprocessing steps (executed in order)
steps:
  # Reorient image to RAS (Right-Anterior-Superior) standard orientation
  # Requires affine matrix from NIfTI file
  reorient_to_ras: false
  
  # Resample to isotropic spacing (e.g., 1mm x 1mm)
  # Set to target spacing in mm, or false to skip
  resample_isotropic: false  # Can be set to 1.0 for 1mm isotropic
  
  # N4 bias field correction using SimpleITK
  # Corrects intensity non-uniformity in MRI scans
  n4_bias_correction: true
  
  # Intensity clipping to remove outliers
  # pmin: lower percentile threshold
  # pmax: upper percentile threshold
  intensity_clip:
    pmin: 0.5
    pmax: 99.5
  
  # Z-score normalization (standardization)
  # Centers data around 0 with unit variance
  zscore_norm: true
  
  # Histogram matching to NFBS reference distribution
  # Reduces domain shift between external data and training data
  histogram_match_to_nfbs:
    enabled: true
    reference_stats_path: artifacts/nfbs_hist_ref.npz
  
  # Gaussian smoothing before thresholding
  # Reduces noise for more stable thresholding
  smoothing:
    gaussian_sigma: 1.0
  
  # Brain extraction via thresholding
  thresholding:
    # Primary method to use for final mask
    primary: otsu  # Options: otsu, yen, li, triangle
    
    # All candidate methods to compute (for visualization/comparison)
    candidates:
      - otsu
      - yen
      - li
      - triangle
    
    # Mask postprocessing parameters
    postprocess:
      min_size: 5000       # Minimum component size in pixels
      closing: 3           # Morphological closing kernel size
      opening: 1           # Morphological opening kernel size
      fill_holes: true     # Fill internal holes in mask
      keep_largest: true   # Keep only largest connected component

# Export overlay visualizations
export_overlays: true

# Output directory for intermediate results
outputs_dir: outputs/preproc
